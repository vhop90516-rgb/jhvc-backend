 <!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Calculadora Fiscal M√©xico</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
 @keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100px);
    }
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}

:root {
    --primary: #0c4d7b;
    --primary-light: #0052a8;
    --primary-dark: #002857;
    --secondary: #17a2b8;
    --accent: #0078d4;
    --success: #107c10;
    --success-light: #10a810;
    --warning: #ff8c00;
    --error: #d13438;
    --gray-50: #fafafa;
    --gray-100: #f5f5f5;
    --gray-200: #e0e0e0;
    --gray-300: #bdbdbd;
    --gray-400: #9e9e9e;
    --gray-500: #757575;
    --gray-600: #616161;
    --gray-700: #424242;
    --gray-800: #212121;
    --white: #ffffff;
    --border: #d0d0d0;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    --shadow-md: 0 2px 4px 0 rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 4px 8px 0 rgba(0, 0, 0, 0.15);
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: 'Segoe UI', 'Arial', sans-serif;
    background: #e8edf2;
    height: 100vh;
    color: var(--gray-800);
    line-height: 1.5;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* ========== HEADER IGUAL AL DASHBOARD ========== */
.header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 1rem 2rem;
    box-shadow: var(--shadow-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 70px;
    z-index: 1000;
    font-style: italic;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-title {
    font-size: 2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-title i {
    font-size: 2.2rem;
}

.user-badge {
    background-color: rgba(255, 255, 255, 0.3);
    padding: 5px 15px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    animation: pulse 2s infinite;
    display: inline-block;
    margin-left: 10px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.back-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s;
}

.user-menu:hover {
    background: rgba(255, 255, 255, 0.1);
}

.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.user-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.user-name {
    font-weight: 600;
    font-size: 1rem;
}

.user-role {
    font-size: 0.85rem;
    opacity: 0.9;
}

/* Container principal con flex */
.main-container {
    display: flex;
    flex: 1;
    overflow: hidden;
    gap: 20px;
    padding: 20px;
    margin-top: 70px;
}

/* Sidebar izquierdo - Men√∫ de opciones */
.sidebar {
    width: 380px;
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
}

.sidebar-header {
    background: var(--gray-100);
    padding: 16px;
    border-bottom: 1px solid var(--border);
}

.sidebar-header h2 {
    font-size: 1rem;
    color: var(--primary);
    font-weight: 600;
}

.menu-options {
    display: flex;
    flex-direction: column;
    padding: 12px;
    gap: 8px;
    border-bottom: 1px solid var(--border);
}

.menu-btn {
    background: var(--white);
    border: 2px solid var(--border);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--gray-700);
}

.menu-btn:hover {
    border-color: var(--primary);
    background: var(--gray-50);
}

.menu-btn.active {
    background: var(--primary);
    color: var(--white);
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
}

.menu-btn-icon {
    font-size: 1.2rem;
}

.menu-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.calculator-form {
    display: none;
}

.calculator-form.active {
    display: block;
    animation: fadeInLeft 0.3s ease;
}

.form-group {
    margin-bottom: 16px;
}

label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--gray-700);
    font-size: 0.85rem;
}

input, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--white);
    color: var(--gray-800);
    transition: all 0.2s ease;
    font-family: inherit;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 61, 130, 0.1);
}

input:hover, select:hover {
    border-color: var(--gray-400);
}

input[type="number"] {
    font-family: 'Consolas', 'Courier New', monospace;
    text-align: right;
}

select {
    cursor: pointer;
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%23616161"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 35px;
}

button {
    background: var(--primary);
    color: var(--white);
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s ease;
    font-family: inherit;
}

button:hover {
    background: var(--primary-light);
}

button:active {
    background: var(--primary-dark);
    transform: scale(0.98);
}

/* Panel derecho - Resultados */
.results-panel {
    flex: 1;
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
}

.results-header {
    background: var(--gray-100);
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.results-header h2 {
    font-size: 1rem;
    color: var(--primary);
    font-weight: 600;
}

.results-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--gray-400);
    text-align: center;
    padding: 20px;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

.empty-state h3 {
    font-size: 1.1rem;
    color: var(--gray-500);
    margin-bottom: 8px;
}

.empty-state p {
    font-size: 0.9rem;
}

/* Resultado */
.resultado {
    background: #f0f9ff;
    border: 2px solid #0078d4;
    padding: 20px;
    border-radius: 12px;
    animation: fadeInRight 0.3s ease;
}

.resultado h3 {
    margin-bottom: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
    border-bottom: 2px solid var(--primary);
    padding-bottom: 8px;
}

.resultado-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.resultado-item {
    background: var(--white);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
}

.resultado-item strong {
    display: block;
    margin-bottom: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
}

.resultado-valor {
    font-size: 1.2rem;
    font-weight: 700;
    font-family: 'Consolas', 'Courier New', monospace;
    color: var(--gray-800);
    word-break: break-all;
}

.resultado-item.total {
    background: var(--primary);
    color: var(--white);
    border: none;
    box-shadow: var(--shadow-md);
}

.resultado-item.total strong {
    color: rgba(255, 255, 255, 0.9);
}

.resultado-item.total .resultado-valor {
    color: var(--white);
    font-size: 1.4rem;
}

.error {
    background: #fef2f2;
    border: 1px solid var(--error);
    color: #991b1b;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.error::before {
    content: '‚ö†';
    font-size: 1.3rem;
    color: var(--error);
}

/* Botones de acci√≥n */
.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-add {
    background: var(--success);
    flex: 1;
    min-width: 120px;
}

.btn-add:hover {
    background: var(--success-light);
}

.btn-clear {
    background: var(--error);
    flex: 1;
}

.btn-clear:hover {
    background: #b92b2f;
}

/* Tabla de c√°lculos m√∫ltiples */
.tabla-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--border);
}

.tabla-header {
    margin-bottom: 12px;
}

.tabla-header h3 {
    color: var(--primary);
    font-size: 1rem;
    font-weight: 600;
}

/* Contenedor scrolleable para tabla */
.tabla-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

table {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.8rem;
}

thead {
    background: var(--gray-100);
    border-bottom: 2px solid var(--border);
}

thead th {
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.75rem;
    text-transform: uppercase;
    border-right: 1px solid var(--border);
    white-space: nowrap;
}

thead th:last-child {
    border-right: none;
}

tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
}

tbody tr:hover {
    background: var(--gray-50);
}

tbody td {
    padding: 8px;
    border-right: 1px solid var(--border);
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 0.75rem;
}

tbody td:nth-child(2),
tbody td:nth-child(3) {
    font-family: 'Segoe UI', 'Arial', sans-serif;
    font-size: 0.7rem;
}

tbody td:last-child {
    border-right: none;
    font-weight: 600;
}

tfoot {
    background: #e3f2fd;
    font-weight: 700;
    border-top: 2px solid var(--primary);
}

tfoot td {
    padding: 10px 8px;
    color: var(--primary);
    border-right: 1px solid var(--border);
    font-size: 0.75rem;
}

tfoot td:last-child {
    border-right: none;
}

/* Secci√≥n de configuraciones en el panel derecho */
.config-display {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--border);
}

.config-display h3 {
    color: var(--primary);
    margin-bottom: 12px;
    font-size: 0.95rem;
    font-weight: 600;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.config-item {
    background: var(--white);
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    border-left: 3px solid var(--primary);
    transition: all 0.2s ease;
}

.config-item:hover {
    box-shadow: var(--shadow-md);
    border-left-color: var(--accent);
}

.config-item strong {
    color: var(--primary);
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    font-size: 0.85rem;
}

.config-item small {
    color: var(--gray-600);
    font-size: 0.75rem;
    line-height: 1.5;
}

/* Scrollbar personalizado */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--gray-100);
}

::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: 8px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
}

/* Animaciones */
@keyframes fadeInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .sidebar {
        width: 320px;
    }
    
    .resultado-grid {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    }
    
    .config-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    body {
        overflow-y: auto;
        height: auto;
    }

    .header {
        padding: 1rem;
        height: auto;
        min-height: 70px;
    }

    .header-left {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
    
    .header-title {
        font-size: 1.5rem;
    }
    
    .user-badge {
        font-size: 0.9rem;
        padding: 3px 10px;
    }
    
    .user-info {
        display: none;
    }

    .back-btn {
        font-size: 0.85rem;
        padding: 6px 12px;
    }
    
    .main-container {
        flex-direction: column;
        overflow-y: auto;
        padding: 12px;
        gap: 12px;
        height: auto;
        margin-top: 80px;
    }
    
    .sidebar {
        width: 100%;
        max-height: none;
        min-height: auto;
    }
    
    .results-panel {
        min-height: 400px;
        height: auto;
    }
    
    .resultado-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    table {
        font-size: 0.7rem;
        min-width: 650px;
    }
    
    .config-grid {
        grid-template-columns: 1fr;
        max-height: none;
    }
}

@media (max-width: 480px) {
    .resultado-grid {
        grid-template-columns: 1fr;
    }
    
    table {
        min-width: 600px;
        font-size: 0.65rem;
    }
}
</style>
</head>
<body>
   <!-- HEADER IGUAL AL DASHBOARD -->
   <header class="header">
        <div class="header-left">
            <div class="header-title">
                <i class="fas fa-calculator"></i>
                JHVC
                <span class="user-badge" id="userBadge">Usuario</span>
            </div>
        </div>
        <div class="header-right">
            <a href="/dashboard" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Dashboard</span>
            </a>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">JH</div>
                <div class="user-info">
                    <span class="user-name" id="userName">Usuario</span>
                    <span class="user-role">Calculadora</span>
                </div>
            </div>
        </div>
    </header>

   <!-- Container Principal con Sidebar + Resultados -->
   <div class="main-container">
       <!-- SIDEBAR IZQUIERDO - Men√∫ y Formularios -->
       <div class="sidebar">
           <div class="sidebar-header">
               <h2>üéØ M√≥dulo de C√°lculos</h2>
           </div>

           <!-- Men√∫ de Opciones -->
           <div class="menu-options">
               <button class="menu-btn active" onclick="cambiarMenu('quitar-iva')" id="btn-quitar-iva">
                   <span class="menu-btn-icon">‚ûñ</span>
                   <span>Quitar IVA</span>
               </button>
               <button class="menu-btn" onclick="cambiarMenu('directo')" id="btn-directo">
                   <span class="menu-btn-icon">‚ûï</span>
                   <span>C√°lculo Directo</span>
               </button>
               <button class="menu-btn" onclick="cambiarMenu('inverso')" id="btn-inverso">
                   <span class="menu-btn-icon">üîÑ</span>
                   <span>C√°lculo Inverso</span>
               </button>
           </div>

           <!-- Contenido del Men√∫ -->
           <div class="menu-content">
               <!-- QUITAR IVA -->
               <div id="form-quitar-iva" class="calculator-form active">
                   <div class="form-group">
                       <label>Precio CON IVA:</label>
                       <input type="number" id="precioConIVA" placeholder="1160.00" step="0.01">
                   </div>
                   
                   <div class="form-group">
                       <label>Tasa de IVA:</label>
                       <select id="tasaIVA">
                           <option value="0.16">16% (General)</option>
                           <option value="0.08">8% (Frontera Norte)</option>
                           <option value="0.0">0% (Exento)</option>
                       </select>
                   </div>
                   
                   <button onclick="quitarIVA()">Calcular</button>
               </div>

               <!-- C√ÅLCULO DIRECTO -->
               <div id="form-directo" class="calculator-form">
                   <div class="form-group">
                       <label>Subtotal (sin impuestos):</label>
                       <input type="number" id="subtotalDirecto" placeholder="1000.00" step="0.01">
                   </div>
                   
                   <div class="form-group">
                       <label>Configuraci√≥n:</label>
                       <select id="configDirecto"></select>
                   </div>
                   
                   <div class="form-group">
                       <label>Retenci√≥n IVA Especial (opcional):</label>
                       <input type="number" id="retencionEspecialDirecto" placeholder="0.04 para 4%" step="0.01" value="0">
                   </div>
                   
                   <button onclick="calcularDirecto()">Calcular</button>
               </div>

               <!-- C√ÅLCULO INVERSO -->
               <div id="form-inverso" class="calculator-form">
                   <div class="form-group">
                       <label>Total Final:</label>
                       <input type="number" id="totalInverso" placeholder="1000.00" step="0.01">
                   </div>
                   
                   <div class="form-group">
                       <label>Configuraci√≥n:</label>
                       <select id="configInverso"></select>
                   </div>
                   
                   <div class="form-group">
                       <label>Retenci√≥n IVA Especial (opcional):</label>
                       <input type="number" id="retencionEspecialInverso" placeholder="0.04 para 4%" step="0.01" value="0">
                   </div>
                   
                   <button onclick="calcularInverso()">Calcular</button>
               </div>
           </div>
       </div>

       <!-- PANEL DERECHO - Resultados -->
       <div class="results-panel">
           <div class="results-header">
               <h2>üìä Resultados</h2>
               <div class="action-buttons">
                   <button class="btn-add" onclick="agregarATabla()" style="width: auto; padding: 8px 16px;">
                       ‚ûï Agregar a Tabla
                   </button>
               </div>
           </div>

           <div class="results-content" id="results-content">
               <!-- Estado vac√≠o inicial -->
               <div class="empty-state" id="empty-state">
                   <div class="empty-state-icon">üìã</div>
                   <h3>Sin resultados</h3>
                   <p>Selecciona un m√©todo de c√°lculo y completa los datos para ver los resultados aqu√≠.</p>
               </div>

               <!-- Aqu√≠ se mostrar√°n los resultados -->
               <div id="resultado"></div>

               <!-- Tabla de c√°lculos m√∫ltiples -->
               <div id="tablaSection" style="display: none;" class="tabla-section">
                   <div class="tabla-header">
                       <h3>üìä Registro de C√°lculos M√∫ltiples</h3>
                   </div>
                   <table>
                       <thead>
                           <tr>
                               <th>#</th>
                               <th>Tipo</th>
                               <th>Config</th>
                               <th>Subtotal</th>
                               <th>IVA</th>
                               <th>ISH</th>
                               <th>Ret. ISR</th>
                               <th>Ret. IVA</th>
                               <th>Total</th>
                           </tr>
                       </thead>
                       <tbody id="tablaBody"></tbody>
                       <tfoot id="tablaFoot"></tfoot>
                   </table>
                   <div class="action-buttons">
                       <button class="btn-clear" onclick="limpiarTabla()">üóëÔ∏è Limpiar Tabla</button>
                   </div>
               </div>

               <!-- Configuraciones disponibles -->
               <div class="config-display">
                   <h3>‚öôÔ∏è Configuraciones Fiscales Disponibles</h3>
                   <div class="config-grid" id="listaConfiguraciones"></div>
               </div>
           </div>
       </div>
   </div>

   <script>
       let configuraciones = [];
       let ultimoResultado = null;
       let calculos = [];
       let contadorID = 1;
       
       // Funci√≥n para cambiar entre men√∫s
       function cambiarMenu(menuId) {
           // Ocultar todos los formularios
           document.querySelectorAll('.calculator-form').forEach(form => {
               form.classList.remove('active');
           });
           
           // Desactivar todos los botones
           document.querySelectorAll('.menu-btn').forEach(btn => {
               btn.classList.remove('active');
           });
           
           // Activar el formulario seleccionado
           document.getElementById('form-' + menuId).classList.add('active');
           document.getElementById('btn-' + menuId).classList.add('active');
       }
       


       function copiarAlPortapapeles(valor) {
            // Limpiar el n√∫mero: quitar $, comas y espacios
            const numeroLimpio = valor.replace(/[$,\s]/g, '');
            
            navigator.clipboard.writeText(numeroLimpio).then(() => {
                // Mostrar feedback visual
                const toast = document.createElement('div');
                toast.textContent = '‚úì Copiado: ' + numeroLimpio;
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#107c10;color:white;padding:12px 20px;border-radius:8px;z-index:9999;font-weight:600;animation:slideIn 0.3s ease;';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }).catch(err => {
                alert('Error al copiar: ' + err);
            });
        }
        async function cargarConfiguraciones() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/calculadora/configuraciones', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Error al cargar configuraciones');
            }
            
            const data = await response.json();
            configuraciones = data.data;
        
            const selectDirecto = document.getElementById('configDirecto');
            const selectInverso = document.getElementById('configInverso');
            const listaDiv = document.getElementById('listaConfiguraciones');
            
            selectDirecto.innerHTML = '';
            selectInverso.innerHTML = '';
            listaDiv.innerHTML = '';
            
            configuraciones.forEach((config, index) => {
                const option1 = document.createElement('option');
                option1.value = index;
                option1.textContent = config.descripcion;
                selectDirecto.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = index;
                option2.textContent = config.descripcion;
                selectInverso.appendChild(option2);
                
                const configDiv = document.createElement('div');
                configDiv.className = 'config-item';
                configDiv.innerHTML = '<strong>' + config.descripcion + '</strong><small>IVA: ' + (config.iva_rate * 100).toFixed(2) + '% | ISR: ' + (config.isr_rate * 100).toFixed(2) + '% | ISH: ' + (config.ish_rate * 100).toFixed(2) + '% | Ret. IVA: ' + (config.iva_retencion ? '2/3 del IVA' : 'No') + '</small>';
                listaDiv.appendChild(configDiv);
            });
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error cargando configuraciones');
        }
    }
       
       function quitarIVA() {
           const precioConIVA = parseFloat(document.getElementById('precioConIVA').value);
           const tasaIVA = parseFloat(document.getElementById('tasaIVA').value);
           
           if (isNaN(precioConIVA) || precioConIVA <= 0) {
               mostrarError('Por favor ingresa un precio v√°lido');
               return;
           }
           
           const factor = 1 + tasaIVA;
           const precioSinIVA = precioConIVA / factor;
           const ivaCalculado = precioConIVA - precioSinIVA;
           
           ultimoResultado = {
               subtotal: precioSinIVA,
               iva: ivaCalculado,
               ish: 0,
               retencion_isr: 0,
               retencion_iva: 0,
               total: precioConIVA,
               factor: factor,
               tipo_calculo: 'quitar_iva',
               configuracion: 'Quitar IVA ' + (tasaIVA * 100).toFixed(0) + '%'
           };
           
           mostrarResultado(ultimoResultado);
       }
       
       async function calcularDirecto() {
           const subtotal = parseFloat(document.getElementById('subtotalDirecto').value);
           const configIndex = parseInt(document.getElementById('configDirecto').value);
           const retencionEspecial = parseFloat(document.getElementById('retencionEspecialDirecto').value) || 0;
           
           if (isNaN(subtotal) || subtotal <= 0) {
               mostrarError('Por favor ingresa un subtotal v√°lido');
               return;
           }
           
           await enviarCalculo('directo', subtotal, configIndex, retencionEspecial);
       }
       
       async function calcularInverso() {
           const total = parseFloat(document.getElementById('totalInverso').value);
           const configIndex = parseInt(document.getElementById('configInverso').value);
           const retencionEspecial = parseFloat(document.getElementById('retencionEspecialInverso').value) || 0;
           
           if (isNaN(total) || total <= 0) {
               mostrarError('Por favor ingresa un total v√°lido');
               return;
           }
           
           await enviarCalculo('inverso', total, configIndex, retencionEspecial);
       }
       
         // Reemplaza la funci√≥n enviarCalculo() existente con esta:
        
         async function enviarCalculo(tipo, monto, configIndex, retencionEspecial) {
        try {
            const token = localStorage.getItem('token');
            const params = new URLSearchParams({
                tipo: tipo,
                monto: monto.toString(),
                config: configIndex.toString(),
                retencion_especial: retencionEspecial.toString()
            });
            
            const response = await fetch('/api/calculadora/calcular?' + params, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Error en el c√°lculo');
            }
            
            const data = await response.json();
            ultimoResultado = data.data;
            mostrarResultado(data.data);
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error de conexi√≥n: ' + error.message);
        }
    }
       
        function mostrarResultado(resultado) {
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const div = document.getElementById('resultado');
            let tipoTexto = '';
            if (resultado.tipo_calculo === 'directo') tipoTexto = 'Directo';
            else if (resultado.tipo_calculo === 'inverso') tipoTexto = 'Inverso';
            else if (resultado.tipo_calculo === 'quitar_iva') tipoTexto = 'Quitar IVA';
            
            let html = '<div class="resultado">';
            html += '<h3>Resultado del C√°lculo ' + tipoTexto + '</h3>';
            html += '<p><strong>' + resultado.configuracion + '</strong></p>';
            html += '<div class="resultado-grid">';
            
            const subtotalLabel = resultado.tipo_calculo === 'quitar_iva' ? 'Precio SIN IVA' : 'Subtotal';
            html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.subtotal) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>' + subtotalLabel + '</strong><div class="resultado-valor">$' + formatearNumero(resultado.subtotal) + '</div></div>';
            
            html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.iva) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>IVA</strong><div class="resultado-valor">$' + formatearNumero(resultado.iva) + '</div></div>';
            
            if (resultado.ish && resultado.ish > 0) {
                html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.ish) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>ISH (5%)</strong><div class="resultado-valor">$' + formatearNumero(resultado.ish) + '</div></div>';
            }
            
            if (resultado.tipo_calculo !== 'quitar_iva') {
                html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.retencion_isr) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>Ret. ISR</strong><div class="resultado-valor">-$' + formatearNumero(resultado.retencion_isr) + '</div></div>';
                html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.retencion_iva) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>Ret. IVA</strong><div class="resultado-valor">-$' + formatearNumero(resultado.retencion_iva) + '</div></div>';
            }
            
            const totalLabel = resultado.tipo_calculo === 'quitar_iva' ? 'Precio CON IVA' : 'TOTAL';
            html += '<div class="resultado-item total" onclick="copiarAlPortapapeles(\'' + formatearNumero(resultado.total) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>' + totalLabel + '</strong><div class="resultado-valor">$' + formatearNumero(resultado.total) + '</div></div>';
            
            if (resultado.factor > 0) {
                html += '<div class="resultado-item" onclick="copiarAlPortapapeles(\'' + resultado.factor.toFixed(6) + '\')" style="cursor:pointer;" title="Click para copiar"><strong>Factor</strong><div class="resultado-valor">' + resultado.factor.toFixed(6) + '</div></div>';
            }
            
            html += '</div></div>';
            div.innerHTML = html;
        }

       function agregarATabla() {
           if (!ultimoResultado) {
               alert('Primero calcula un resultado');
               return;
           }
           
           calculos.push({
               id: contadorID++,
               ...ultimoResultado
           });
           
           actualizarTabla();
           document.getElementById('tablaSection').style.display = 'block';
       }

       function actualizarTabla() {
           const tbody = document.getElementById('tablaBody');
           const tfoot = document.getElementById('tablaFoot');
           
           tbody.innerHTML = '';
           
           let totales = {
               subtotal: 0,
               iva: 0,
               ish: 0,
               retISR: 0,
               retIVA: 0,
               total: 0
           };
           
           calculos.forEach((calc) => {
               const tr = document.createElement('tr');
               tr.innerHTML = '<td>' + calc.id + '</td>' +
                   '<td>' + calc.tipo_calculo + '</td>' +
                   '<td><small>' + calc.configuracion + '</small></td>' +
                   '<td>$' + formatearNumero(calc.subtotal) + '</td>' +
                   '<td>$' + formatearNumero(calc.iva) + '</td>' +
                   '<td>$' + formatearNumero(calc.ish || 0) + '</td>' +
                   '<td>-$' + formatearNumero(calc.retencion_isr) + '</td>' +
                   '<td>-$' + formatearNumero(calc.retencion_iva) + '</td>' +
                   '<td><strong>$' + formatearNumero(calc.total) + '</strong></td>';
               tbody.appendChild(tr);
               
               totales.subtotal += calc.subtotal;
               totales.iva += calc.iva;
               totales.ish += (calc.ish || 0);
               totales.retISR += calc.retencion_isr;
               totales.retIVA += calc.retencion_iva;
               totales.total += calc.total;
           });
           
           tfoot.innerHTML = '<tr>' +
               '<td colspan="3"><strong>TOTALES:</strong></td>' +
               '<td><strong>$' + formatearNumero(totales.subtotal) + '</strong></td>' +
               '<td><strong>$' + formatearNumero(totales.iva) + '</strong></td>' +
               '<td><strong>$' + formatearNumero(totales.ish) + '</strong></td>' +
               '<td><strong>-$' + formatearNumero(totales.retISR) + '</strong></td>' +
               '<td><strong>-$' + formatearNumero(totales.retIVA) + '</strong></td>' +
               '<td><strong>$' + formatearNumero(totales.total) + '</strong></td>' +
               '</tr>';
       }

       function limpiarTabla() {
           if (confirm('¬øLimpiar todos los c√°lculos de la tabla?')) {
               calculos = [];
               contadorID = 1;
               document.getElementById('tablaBody').innerHTML = '';
               document.getElementById('tablaFoot').innerHTML = '';
               document.getElementById('tablaSection').style.display = 'none';
           }
       }
       
       function mostrarError(mensaje) {
           // Ocultar estado vac√≠o
           const emptyState = document.getElementById('empty-state');
           if (emptyState) {
               emptyState.style.display = 'none';
           }
           
           document.getElementById('resultado').innerHTML = '<div class="error">Error: ' + mensaje + '</div>';
       }
       
       function formatearNumero(num) {
           return num.toFixed(2);
       }
       
       // Seleccionar todo el contenido al hacer clic en cualquier input
       document.addEventListener('DOMContentLoaded', function() {
           // Funci√≥n para seleccionar todo el contenido
           function selectAllOnClick(event) {
               event.target.select();
           }
           
           // Agregar evento a todos los inputs
           function addSelectAllToInputs() {
               const inputs = document.querySelectorAll('input[type="number"]');
               inputs.forEach(input => {
                   input.addEventListener('click', selectAllOnClick);
                   input.addEventListener('focus', selectAllOnClick);
               });
           }
           
           // Ejecutar al cargar y despu√©s de cada actualizaci√≥n
           addSelectAllToInputs();
           
           // Observar cambios en el DOM para nuevos inputs
           const observer = new MutationObserver(function() {
               addSelectAllToInputs();
           });
           
           observer.observe(document.body, {
               childList: true,
               subtree: true
           });
           
           // ENTER para activar c√°lculos
           // Quitar IVA
           document.getElementById('precioConIVA').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   quitarIVA();
               }
           });
           
           document.getElementById('tasaIVA').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   quitarIVA();
               }
           });
           
           // C√°lculo Directo
           document.getElementById('subtotalDirecto').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularDirecto();
               }
           });
           
           document.getElementById('configDirecto').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularDirecto();
               }
           });
           
           document.getElementById('retencionEspecialDirecto').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularDirecto();
               }
           });
           
           // C√°lculo Inverso
           document.getElementById('totalInverso').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularInverso();
               }
           });
           
           document.getElementById('configInverso').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularInverso();
               }
           });
           
           document.getElementById('retencionEspecialInverso').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   calcularInverso();
               }
           });
       });
       
       cargarConfiguraciones();


            // Verificar autenticaci√≥n
         // Verificar autenticaci√≥n
const token = localStorage.getItem('token');
if (!token) {
    window.location.href = '/login';
}

// Cargar datos del usuario en el header
const user = JSON.parse(localStorage.getItem('user') || '{}');
if (user.full_name) {
    const initials = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('userName').textContent = user.full_name;
    document.getElementById('userBadge').textContent = user.full_name;
}
   </script>
</body>
</html>